#!/usr/bin/env ruby
#/ Usage: preview_add <options> <host>...
#/
#/ The host should be the host of the live site, not the preview site.
#/
#/ Add preview sites for the specified host. Creates the DNS, Vhost, htpasswd
#/ file and checks the site out from revision control
#/ 
#/ Options
#/   -f, --htpasswd   specify the htpasswd file to use
#/   -u, --username   username for the htpasswd file
#/   -p, --password   password for the htpasswd file
#/   -h, --help       show this help message
require 'preview_add'
require 'optparse'

if ENV['USER'] != 'root'
  puts "You must run preview as root"
  exit 1
end

def usage
  puts File.readlines(__FILE__).
    grep(/^#\/.*/).
    map { |line| line.chomp[3..-1] }.
    join("\n")
end

options = {}

optparse = OptionParser.new do |opts| 
  
  opts.on( '-f', '--htpasswd [file]') do |arg|
    options[:htpasswd] = arg
  end
  
  opts.on( '-u', '--username [username]') do |arg|
    options[:username] = arg
  end
  
  opts.on( '-p', '--password [password]') do |arg|
    options[:password] = arg
  end

  opts.on('-v', '--version') do
    puts PreviewAdd::VERSION
    exit 0
  end

  opts.on('-h', '--help', 'Display help info') do
    usage
    exit 0
  end
end

begin
  optparse.parse!
  
  # The url has no flag and will be in ARGV[0] if it's set
  options[:host] = ARGV[0] || nil

  # Reset ARGV for gets later
  ARGV.clear
  
  mandatory = [:host]
  missing = mandatory.select{ |param| options[param].nil? }
  unless missing.empty?
    puts "Missing option#{'s' if missing.length > 1}: #{missing.join(', ')}"
    usage
    exit 1
  end
rescue OptionParser::InvalidOption, OptionParser::MissingArgument
  puts $!.to_s
  usage
  exit 1
end

preview = PreviewAdd::PreviewAdd.new(options)
preview.add_site