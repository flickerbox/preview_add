#!/usr/bin/env ruby
require 'preview'
require 'optparse'

# config  = Preview::Config.new

options = {}

optparse = OptionParser.new do |opts| 
  
  opts.on( '-s', '--site url', "Website URL. URL of the actual domain, not the preview dowmain." ) do |arg|
    options[:host] = arg
  end
  
  opts.on( '-f', '--htpasswd [file]', "Specify the htpasswd file to use" ) do |arg|
    options[:htpasswd] = arg
  end
  
  opts.on( '-u', '--username [username]', "Username for the htpasswd file." ) do |arg|
    options[:username] = arg
  end
  
  opts.on( '-p', '--password [password]', "Password for the htpasswd file." ) do |arg|
    options[:password] = arg
  end

  opts.on('-h', '--help', 'Display help info') do                                                                                                                                                               
    puts opts                                                                                                                                                                                                     
    exit                                                                                                                                                                                                          
  end
end

begin
  optparse.parse!
  mandatory = [:host]
  missing = mandatory.select{ |param| options[param].nil? }
  if not missing.empty?
    puts "Missing options: #{missing.join(', ')}"
    puts optparse
    exit
  end
rescue OptionParser::InvalidOption, OptionParser::MissingArgument
  puts $!.to_s
  puts optparse
  exit
end

begin
  preview = Preview::Preview.new(options)
  preview.add_site
rescue Exception => e
  puts e.to_s
  exit 1
end